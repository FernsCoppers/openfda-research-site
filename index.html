<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>openFDA Research Site (MAUDE + Recalls)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; line-height: 1.35; }
    h1 { margin-bottom: 6px; }
    .note { color: #444; max-width: 980px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin: 16px 0; max-width: 1100px; }
    label { display: inline-block; min-width: 170px; margin: 6px 0; }
    input, select { padding: 8px; width: 320px; max-width: 95%; }
    button { padding: 10px 14px; margin: 10px 8px 0 0; cursor: pointer; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background: #f6f6f6; }
    .row { display: flex; flex-wrap: wrap; gap: 10px 22px; align-items: center; }
    .muted { color: #666; }
    .error { color: #b00020; white-space: pre-wrap; }
    .small { font-size: 0.92rem; }
    code { background:#f6f6f6; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <h1>openFDA Research Site</h1>
  <div class="note small">
    This site helps explore public openFDA datasets for research and awareness purposes.
    MAUDE reports and recall records have limitations (incomplete, biased, underreporting; not validated for causality).
  </div>

  <div class="card">
    <h2>1) MAUDE Explorer (Device Adverse Events)</h2>
    <div class="muted small">Endpoint: <code>https://api.fda.gov/device/event.json</code></div>

    <div class="row">
      <div>
        <label>Device keyword (generic name)</label><br/>
        <input id="maudeKeyword" placeholder='Example: x-ray' value="x-ray" />
      </div>
      <div>
        <label>Date received (optional)</label><br/>
        <input id="maudeDateFrom" placeholder="From: YYYYMMDD (e.g., 20200101)" />
      </div>
      <div>
        <label>&nbsp;</label><br/>
        <input id="maudeDateTo" placeholder="To: YYYYMMDD (e.g., 20241231)" />
      </div>
      <div>
        <label>Rows (limit)</label><br/>
        <input id="maudeLimit" type="number" min="1" max="100" value="10" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Count field (optional)</label><br/>
        <select id="maudeCount">
          <option value="">(none)</option>
          <option value="event_type.exact">event_type.exact</option>
          <option value="device.generic_name.exact">device.generic_name.exact</option>
          <option value="manufacturer_name.exact">manufacturer_name.exact</option>
        </select>
      </div>
    </div>

    <button onclick="runMaudeSearch()">Run MAUDE Search</button>
    <button onclick="runMaudeCount()">Run MAUDE Count</button>

    <div id="maudeMeta" class="muted small" style="margin-top:10px;"></div>
    <div id="maudeError" class="error"></div>
    <div id="maudeOut"></div>
  </div>

  <div class="card">
    <h2>2) Device Recall Explorer</h2>
    <div class="muted small">Endpoint: <code>https://api.fda.gov/device/recall.json</code></div>

    <div class="row">
      <div>
        <label>Search field</label><br/>
        <select id="recallField">
          <option value="product_code">product_code</option>
          <option value="openfda.regulation_number">openfda.regulation_number</option>
          <option value="root_cause_description.exact">root_cause_description.exact</option>
          <option value="recalling_firm.exact">recalling_firm.exact</option>
        </select>
      </div>
      <div>
        <label>Search value</label><br/>
        <input id="recallValue" placeholder='Example: FOZ' value="FOZ" />
      </div>
      <div>
        <label>Rows (limit)</label><br/>
        <input id="recallLimit" type="number" min="1" max="100" value="10" />
      </div>
      <div>
        <label>Count field (optional)</label><br/>
        <select id="recallCount">
          <option value="">(none)</option>
          <option value="product_code">product_code</option>
          <option value="classification.exact">classification.exact</option>
          <option value="reason_for_recall.exact">reason_for_recall.exact</option>
        </select>
      </div>
    </div>

    <button onclick="runRecallSearch()">Run Recall Search</button>
    <button onclick="runRecallCount()">Run Recall Count</button>

    <div id="recallMeta" class="muted small" style="margin-top:10px;"></div>
    <div id="recallError" class="error"></div>
    <div id="recallOut"></div>
  </div>

<script>
  // ---------- Helpers ----------
  function esc(s) {
    return String(s ?? "").replace(/[&<>"']/g, m => (
      {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
    ));
  }

  function buildTable(rows, columns) {
    if (!rows || rows.length === 0) return "<div class='muted'>No results returned.</div>";
    let html = "<table><thead><tr>";
    for (const c of columns) html += `<th>${esc(c)}</th>`;
    html += "</tr></thead><tbody>";
    for (const r of rows) {
      html += "<tr>";
      for (const c of columns) html += `<td>${esc(r[c])}</td>`;
      html += "</tr>";
    }
    html += "</tbody></table>";
    return html;
  }

  async function fetchJson(url) {
    const r = await fetch(url);
    const data = await r.json();
    if (!r.ok) {
      const msg = (data && data.error && data.error.message)
        ? data.error.message
        : JSON.stringify(data, null, 2);
      throw new Error(msg);
    }
    return data;
  }

  function setMeta(elId, url) {
    document.getElementById(elId).innerHTML = `Query URL: <code>${esc(url)}</code>`;
  }

  // ---------- URL state (shareable searches) ----------
  function setUrlParams(params) {
    const url = new URL(window.location.href);
    Object.entries(params).forEach(([k, v]) => {
      if (v === "" || v === null || v === undefined) url.searchParams.delete(k);
      else url.searchParams.set(k, v);
    });
    window.history.replaceState({}, "", url.toString());
  }

  function getFieldValues() {
    return {
      maude_kw: document.getElementById("maudeKeyword").value.trim(),
      maude_from: document.getElementById("maudeDateFrom").value.trim(),
      maude_to: document.getElementById("maudeDateTo").value.trim(),
      maude_limit: String(document.getElementById("maudeLimit").value || "").trim(),
      maude_count: document.getElementById("maudeCount").value.trim(),

      recall_field: document.getElementById("recallField").value.trim(),
      recall_val: document.getElementById("recallValue").value.trim(),
      recall_limit: String(document.getElementById("recallLimit").value || "").trim(),
      recall_count: document.getElementById("recallCount").value.trim()
    };
  }

  function loadFromUrlParams() {
    const url = new URL(window.location.href);
    const sp = url.searchParams;

    // MAUDE
    if (sp.get("maude_kw") !== null) document.getElementById("maudeKeyword").value = sp.get("maude_kw");
    if (sp.get("maude_from") !== null) document.getElementById("maudeDateFrom").value = sp.get("maude_from");
    if (sp.get("maude_to") !== null) document.getElementById("maudeDateTo").value = sp.get("maude_to");
    if (sp.get("maude_limit") !== null) document.getElementById("maudeLimit").value = sp.get("maude_limit");
    if (sp.get("maude_count") !== null) document.getElementById("maudeCount").value = sp.get("maude_count");

    // RECALL
    if (sp.get("recall_field") !== null) document.getElementB_
