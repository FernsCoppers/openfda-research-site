<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>openFDA Research Site (MAUDE + Recalls)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; line-height: 1.35; }
    h1 { margin-bottom: 6px; }
    .note { color: #444; max-width: 980px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin: 16px 0; max-width: 1100px; }
    label { display: inline-block; min-width: 170px; margin: 6px 0; }
    input, select { padding: 8px; width: 320px; max-width: 95%; }
    button { padding: 10px 14px; margin: 10px 8px 0 0; cursor: pointer; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background: #f6f6f6; }
    .row { display: flex; flex-wrap: wrap; gap: 10px 22px; align-items: center; }
    .muted { color: #666; }
    .error { color: #b00020; white-space: pre-wrap; }
    .small { font-size: 0.92rem; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius: 999px; margin-left:6px; }
    code { background:#f6f6f6; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <h1>openFDA Research Site</h1>
  <div class="note small">
    This site helps explore public openFDA datasets for research and awareness purposes. MAUDE reports and recall records have limitations (incomplete, biased, underreporting; not validated for causality).
  </div>

  <div class="card">
    <h2>1) MAUDE Explorer (Device Adverse Events)</h2>
    <div class="muted small">Endpoint: <code>https://api.fda.gov/device/event.json</code></div>

    <div class="row">
      <div>
        <label>Device keyword (generic name)</label><br/>
        <input id="maudeKeyword" placeholder='Example: x-ray' value="x-ray" />
      </div>
      <div>
        <label>Date received (optional)</label><br/>
        <input id="maudeDateFrom" placeholder="From: YYYYMMDD (e.g., 20200101)" />
      </div>
      <div>
        <label>&nbsp;</label><br/>
        <input id="maudeDateTo" placeholder="To: YYYYMMDD (e.g., 20241231)" />
      </div>
      <div>
        <label>Rows (limit)</label><br/>
        <input id="maudeLimit" type="number" min="1" max="100" value="10" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Count field (optional)</label><br/>
        <select id="maudeCount">
          <option value="">(none)</option>
          <option value="event_type.exact">event_type.exact</option>
          <option value="device.generic_name.exact">device.generic_name.exact</option>
          <option value="manufacturer_name.exact">manufacturer_name.exact</option>
        </select>
      </div>
    </div>

    <button onclick="runMaudeSearch()">Run MAUDE Search</button>
    <button onclick="runMaudeCount()">Run MAUDE Count</button>

    <div id="maudeMeta" class="muted small" style="margin-top:10px;"></div>
    <div id="maudeError" class="error"></div>
    <div id="maudeOut"></div>
  </div>

  <div class="card">
    <h2>2) Device Recall Explorer</h2>
    <div class="muted small">Endpoint: <code>https://api.fda.gov/device/recall.json</code></div>

    <div class="row">
      <div>
        <label>Search field</label><br/>
        <select id="recallField">
          <option value="product_code">product_code</option>
          <option value="openfda.regulation_number">openfda.regulation_number</option>
          <option value="root_cause_description.exact">root_cause_description.exact</option>
          <option value="recalling_firm.exact">recalling_firm.exact</option>
        </select>
      </div>
      <div>
        <label>Search value</label><br/>
        <input id="recallValue" placeholder='Example: FOZ' value="FOZ" />
      </div>
      <div>
        <label>Rows (limit)</label><br/>
        <input id="recallLimit" type="number" min="1" max="100" value="10" />
      </div>
      <div>
        <label>Count field (optional)</label><br/>
        <select id="recallCount">
          <option value="">(none)</option>
          <option value="product_code">product_code</option>
          <option value="classification.exact">classification.exact</option>
          <option value="reason_for_recall.exact">reason_for_recall.exact</option>
        </select>
      </div>
    </div>

    <button onclick="runRecallSearch()">Run Recall Search</button>
    <button onclick="runRecallCount()">Run Recall Count</button>

    <div id="recallMeta" class="muted small" style="margin-top:10px;"></div>
    <div id="recallError" class="error"></div>
    <div id="recallOut"></div>
  </div>

<script>
  function esc(s) {
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
function setUrlParams(params) {
  const url = new URL(window.location.href);
  Object.entries(params).forEach(([k,v]) => {
    if (v === "" || v === null || v === undefined) url.searchParams.delete(k);
    else url.searchParams.set(k, v);
  });
  window.history.replaceState({}, "", url.toString());
}

function loadFromUrlParams() {
  const url = new URL(window.location.href);
  const sp = url.searchParams;

  // MAUDE
  if (sp.get("maude_kw") !== null) document.getElementById("maudeKeyword").value = sp.get("maude_kw");
  if (sp.get("maude_from") !== null) document.getElementById("maudeDateFrom").value = sp.get("maude_from");
  if (sp.get("maude_to") !== null) document.getElementById("maudeDateTo").value = sp.get("maude_to");
  if (sp.get("maude_limit") !== null) document.getElementById("maudeLimit").value = sp.get("maude_limit");
  if (sp.get("maude_count") !== null) document.getElementById("maudeCount").value = sp.get("maude_count");

  // RECALL
  if (sp.get("recall_field") !== null) document.getElementById("recallField").value = sp.get("recall_field");
  if (sp.get("recall_val") !== null) document.getElementById("recallValue").value = sp.get("recall_val");
  if (sp.get("recall_limit") !== null) document.getElementById("recallLimit").value = sp.get("recall_limit");
  if (sp.get("recall_count") !== null) document.getElementById("recallCount").value = sp.get("recall_count");
}
window.addEventListener("DOMContentLoaded", () => {
  loadFromUrlParams();

  function syncUrlFromFields() {
    setUrlParams({
      maude_kw: document.getElementById("maudeKeyword").value.trim(),
      maude_from: document.getElementById("maudeDateFrom").value.trim(),
      maude_to: document.getElementById("maudeDateTo").value.trim(),
      maude_limit: String(document.getElementById("maudeLimit").value || "").trim(),
      maude_count: document.getElementById("maudeCount").value.trim(),

      recall_field: document.getElementById("recallField").value.trim(),
      recall_val: document.getElementById("recallValue").value.trim(),
      recall_limit: String(document.getElementById("recallLimit").value || "").trim(),
      recall_count: document.getElementById("recallCount").value.trim()
    });
  }

  // Text/number inputs: update URL as you type
  const inputIds = ["maudeKeyword","maudeDateFrom","maudeDateTo","maudeLimit","recallValue","recallLimit"];
  inputIds.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("input", syncUrlFromFields);
  });

  // Dropdowns: update URL when selection changes
  const selectIds = ["maudeCount","recallField","recallCount"];
  selectIds.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("change", syncUrlFromFields);
  });
});

    return data;
  }

  function setMeta(elId, url) {
    document.getElementById(elId).innerHTML = `Query URL: <code>${esc(url)}</code>`;
  }

  // --- MAUDE ---
  function maudeSearchUrl(countMode) {
    const kw = document.getElementById("maudeKeyword").value.trim();
    const from = document.getElementById("maudeDateFrom").value.trim();
    const to = document.getElementById("maudeDateTo").value.trim();
    const limit = Math.min(Math.max(parseInt(document.getElementById("maudeLimit").value || "10", 10), 1), 100);

    // Build search terms
    const terms = [];
    if (kw) terms.push(`device.generic_name:${kw}`);
    if (from && to) terms.push(`date_received:[${from}+TO+${to}]`);

    const search = terms.length ? `search=${encodeURIComponent(terms.join("+AND+"))}` : "";
    const base = "https://api.fda.gov/device/event.json";

    if (countMode) {
      const c = document.getElementById("maudeCount").value;
      if (!c) throw new Error("Select a count field first (e.g., event_type.exact).");
      return `${base}?${search}${search ? "&" : ""}count=${encodeURIComponent(c)}`;
    }
    return `${base}?${search}${search ? "&" : ""}limit=${limit}`;
  }

  async function runMaudeSearch() {
    document.getElementById("maudeError").textContent = "";
    document.getElementById("maudeOut").innerHTML = "";
    try {
          setUrlParams({
      maude_kw: document.getElementById("maudeKeyword").value.trim(),
      maude_from: document.getElementById("maudeDateFrom").value.trim(),
      maude_to: document.getElementById("maudeDateTo").value.trim(),
      maude_limit: String(document.getElementById("maudeLimit").value || "").trim(),
      maude_count: document.getElementById("maudeCount").value.trim()
    });
      const url = maudeSearchUrl(false);
      setMeta("maudeMeta", url);
      const data = await fetchJson(url);

      const rows = (data.results || []).map(x => ({
        report_number: x.report_number,
        date_received: x.date_received,
        event_type: x.event_type,
        manufacturer_name: x.manufacturer_name,
        brand_name: (x.device && x.device[0] && x.device[0].brand_name) ? x.device[0].brand_name : "",
        generic_name: (x.device && x.device[0] && x.device[0].generic_name) ? x.device[0].generic_name : ""
      }));

      document.getElementById("maudeOut").innerHTML = buildTable(rows, [
        "report_number","date_received","event_type","manufacturer_name","brand_name","generic_name"
      ]);
    } catch (e) {
      document.getElementById("maudeError").textContent = e.message;
    }
  }

  async function runMaudeCount() {
    document.getElementById("maudeError").textContent = "";
    document.getElementById("maudeOut").innerHTML = "";
    try {
          setUrlParams({
      maude_kw: document.getElementById("maudeKeyword").value.trim(),
      maude_from: document.getElementById("maudeDateFrom").value.trim(),
      maude_to: document.getElementById("maudeDateTo").value.trim(),
      maude_limit: String(document.getElementById("maudeLimit").value || "").trim(),
      maude_count: document.getElementById("maudeCount").value.trim()
    });
      const url = maudeSearchUrl(true);
      setMeta("maudeMeta", url);
      const data = await fetchJson(url);

      const rows = (data.results || []).slice(0, 25).map(x => ({
        term: x.term,
        count: x.count
      }));

      document.getElementById("maudeOut").innerHTML =
        `<div class="muted small">Showing top 25 buckets</div>` + buildTable(rows, ["term","count"]);
    } catch (e) {
      document.getElementById("maudeError").textContent = e.message;
    }
  }

  // --- RECALLS ---
  function recallSearchUrl(countMode) {
    const field = document.getElementById("recallField").value;
    const val = document.getElementById("recallValue").value.trim();
    const limit = Math.min(Math.max(parseInt(document.getElementById("recallLimit").value || "10", 10), 1), 100);

    const base = "https://api.fda.gov/device/recall.json";

    if (countMode) {
      const c = document.getElementById("recallCount").value;
      if (!c) throw new Error("Select a count field first (e.g., product_code).");
      return `${base}?count=${encodeURIComponent(c)}`;
    }

    if (!val) throw new Error("Enter a search value (e.g., FOZ).");

    const search = `search=${encodeURIComponent(`${field}:${val}`)}`;
    return `${base}?${search}&limit=${limit}`;
  }

  async function runRecallSearch() {
    document.getElementById("recallError").textContent = "";
    document.getElementById("recallOut").innerHTML = "";
    try {
          setUrlParams({
      maude_kw: document.getElementById("maudeKeyword").value.trim(),
      maude_from: document.getElementById("maudeDateFrom").value.trim(),
      maude_to: document.getElementById("maudeDateTo").value.trim(),
      maude_limit: String(document.getElementById("maudeLimit").value || "").trim(),
      maude_count: document.getElementById("maudeCount").value.trim()
    });
      const url = recallSearchUrl(false);
      setMeta("recallMeta", url);
      const data = await fetchJson(url);

      const rows = (data.results || []).map(x => ({
        recall_number: x.recall_number,
        product_code: x.product_code,
        status: x.status,
        classification: x.classification,
        recalling_firm: x.recalling_firm,
        reason_for_recall: x.reason_for_recall
      }));

      document.getElementById("recallOut").innerHTML = buildTable(rows, [
        "recall_number","product_code","status","classification","recalling_firm","reason_for_recall"
      ]);
    } catch (e) {
      document.getElementById("recallError").textContent = e.message;
    }
  }

  async function runRecallCount() {
    document.getElementById("recallError").textContent = "";
    document.getElementById("recallOut").innerHTML = "";
    try {
          setUrlParams({
      maude_kw: document.getElementById("maudeKeyword").value.trim(),
      maude_from: document.getElementById("maudeDateFrom").value.trim(),
      maude_to: document.getElementById("maudeDateTo").value.trim(),
      maude_limit: String(document.getElementById("maudeLimit").value || "").trim(),
      maude_count: document.getElementById("maudeCount").value.trim()
    });
      const url = recallSearchUrl(true);
      setMeta("recallMeta", url);
      const data = await fetchJson(url);

      const rows = (data.results || []).slice(0, 25).map(x => ({
        term: x.term,
        count: x.count
      }));

      document.getElementById("recallOut").innerHTML =
        `<div class="muted small">Showing top 25 buckets</div>` + buildTable(rows, ["term","count"]);
    } catch (e) {
      document.getElementById("recallError").textContent = e.message;
    }
  }
</script>
</body>
</html>
